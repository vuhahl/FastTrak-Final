<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="FastTrak.Views.CalculatorPage"
             x:Name="CalculatorPageRoot"
             Title="My Tray">

    <ScrollView>
        <VerticalStackLayout Padding="24" Spacing="20">

            <!-- TOP SUMMARY CARD -->
            <Frame CornerRadius="20"
                   Padding="20"
                   HasShadow="True">

                <Frame.Background>
                    <LinearGradientBrush EndPoint="0,1">
                        <GradientStop Color="{StaticResource PrimaryColor}" Offset="0.0"/>
                        <GradientStop Color="{StaticResource InfoColor}" Offset="1.0"/>
                    </LinearGradientBrush>
                </Frame.Background>

                <VerticalStackLayout Spacing="20">

                    <!-- Title -->
                    <Label Text="Today's Totals"
                           FontSize="20"
                           FontAttributes="Bold"
                           TextColor="White" />

                    <!-- Macro Grid -->
                    <Grid ColumnDefinitions="*,*,*,*" ColumnSpacing="18">

                        <VerticalStackLayout Spacing="4" HorizontalOptions="Center">
                            <Label Text="{Binding TotalCalories}"
                                   FontSize="26"
                                   FontAttributes="Bold"
                                   TextColor="White" />
                            <Label Text="Calories"
                                   FontSize="13"
                                   TextColor="#FFEFEFEF" />
                        </VerticalStackLayout>

                        <VerticalStackLayout Grid.Column="1" Spacing="4" HorizontalOptions="Center">
                            <Label Text="{Binding TotalProtein}"
                                   FontSize="26"
                                   FontAttributes="Bold"
                                   TextColor="White" />
                            <Label Text="Protein"
                                   FontSize="13"
                                   TextColor="#FFEFEFEF" />
                        </VerticalStackLayout>

                        <VerticalStackLayout Grid.Column="2" Spacing="4" HorizontalOptions="Center">
                            <Label Text="{Binding TotalCarbs}"
                                   FontSize="26"
                                   FontAttributes="Bold"
                                   TextColor="White" />
                            <Label Text="Carbs"
                                   FontSize="10"
                                   TextColor="#FFEFEFEF" />
                        </VerticalStackLayout>

                        <VerticalStackLayout Grid.Column="3" Spacing="4" HorizontalOptions="Center">
                            <Label Text="{Binding TotalFat}"
                                   FontSize="26"
                                   FontAttributes="Bold"
                                   TextColor="White" />
                            <Label Text="Fat"
                                   FontSize="13"
                                   TextColor="#FFEFEFEF" />
                        </VerticalStackLayout>

                    </Grid>
                </VerticalStackLayout>
            </Frame>



            <!-- ===================== -->
            <!--   M Y   T R A Y       -->
            <!-- ===================== -->

            <CollectionView ItemsSource="{Binding TodayLoggedItems}"
                            Margin="0">

                <CollectionView.EmptyView>
                    <Label Text="Your tray is empty."
                           HorizontalOptions="Center"
                           VerticalOptions="Center"
                           TextColor="{StaticResource TextSecondaryColor}" />
                </CollectionView.EmptyView>

                <CollectionView.ItemTemplate>
                    <DataTemplate>

                        <Frame Padding="16"
                               Margin="0,8"
                               CornerRadius="16"
                               BackgroundColor="{StaticResource SurfaceColor}"
                               HasShadow="False">

                            <VerticalStackLayout Spacing="10">

                                <!-- Name + Remove -->
                                <Grid ColumnDefinitions="*,Auto">

                                    <Label Text="{Binding DisplayName}"
                                           FontSize="16"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource TextPrimaryColor}" />

                                    <!-- UPDATED REMOVE BUTTON -->
                                    <Button Grid.Column="1"
                                            Text="Remove"
                                            BackgroundColor="Transparent"
                                            TextColor="{StaticResource TextSecondaryColor}"
                                            FontSize="13"
                                            Padding="0"
                                            Command="{Binding 
                                                BindingContext.RemoveItemCommand,
                                                Source={x:Reference CalculatorPageRoot}}"
                                            CommandParameter="{Binding .}" />

                                </Grid>

                                <!-- Calories -->
                                <Label Text="{Binding CaloriesOverride, StringFormat='Calories: {0}'}"
                                       TextColor="{StaticResource TextSecondaryColor}" />

                                <!-- Quantity Control Row -->
                                <Grid ColumnDefinitions="Auto,Auto,Auto"
                                      ColumnSpacing="12">

                                    <!-- Decrease -->
                                    <Button Text="-"
                                            WidthRequest="32"
                                            HeightRequest="32"
                                            CornerRadius="16"
                                            BackgroundColor="{StaticResource PrimaryColor}"
                                            TextColor="White"
                                            Command="{Binding 
                                                BindingContext.DecreaseItemQuantityCommand,
                                                Source={x:Reference CalculatorPageRoot}}"
                                            CommandParameter="{Binding .}" />

                                    <!-- Quantity Display -->
                                    <Label Text="{Binding Quantity}"
                                           VerticalOptions="Center"
                                           FontSize="16"
                                           TextColor="{StaticResource TextPrimaryColor}" />

                                    <!-- Increase -->
                                    <Button Text="+"
                                            WidthRequest="32"
                                            HeightRequest="32"
                                            CornerRadius="16"
                                            BackgroundColor="{StaticResource PrimaryColor}"
                                            TextColor="White"
                                            Command="{Binding 
                                                BindingContext.IncreaseItemQuantityCommand,
                                                Source={x:Reference CalculatorPageRoot}}"
                                            CommandParameter="{Binding .}" />
                                </Grid>

                            </VerticalStackLayout>
                        </Frame>

                    </DataTemplate>
                </CollectionView.ItemTemplate>

            </CollectionView>


            <!-- CLEAR ALL -->
            <Button Text="Clear Today's Log"
                    BackgroundColor="{StaticResource InfoColor}"
                    TextColor="Black"
                    FontSize="18"
                    Padding="14"
                    CornerRadius="14"
                    Command="{Binding ClearAllCommand}" />

        </VerticalStackLayout>
    </ScrollView>

</ContentPage>
